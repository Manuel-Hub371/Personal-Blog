<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Manuel</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/inbox.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
</head>

<body>
    <header>
        <div class="container nav">
            <a href="#" class="logo">Admin Console</a>
            <div class="nav-links">
                <a href="index.html" class="btn btn-outline" style="padding: 8px 16px;">View Site</a>
                <button id="logout-btn" class="btn btn-outline"
                    style="padding: 8px 16px; border-color: #ef4444; color: #ef4444;">Logout</button>
            </div>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle Theme"></button>
            <button class="menu-toggle" aria-label="Toggle Menu"
                style="background: none; border: none; color: var(--text-main); cursor: pointer; display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>
    </header>

    <main class="container admin-layout">
        <aside class="admin-nav">
            <div class="glass-card">
                <div class="nav-brand"
                    style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding: 0 16px;">
                    <div
                        style="width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        M</div>
                    <span style="font-weight: 600; font-size: 1.1rem;">Admin</span>
                </div>
                <ul>
                    <li><button onclick="switchView('dashboard')" class="admin-nav-btn active" id="nav-dashboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect width="7" height="9" x="3" y="3" rx="1" />
                                <rect width="7" height="5" x="14" y="3" rx="1" />
                                <rect width="7" height="9" x="14" y="12" rx="1" />
                                <rect width="7" height="5" x="3" y="16" rx="1" />
                            </svg>
                            Dashboard</button></li>
                    <li><button onclick="switchView('posts')" class="admin-nav-btn" id="nav-posts">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                            Stories</button></li>
                    <li><button onclick="switchView('projects')" class="admin-nav-btn" id="nav-projects">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M20 20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h11l5 5v11zM14 2v6h6" />
                            </svg>
                            Projects</button></li>
                    <li><button onclick="switchView('messages')" class="admin-nav-btn" id="nav-messages">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect width="20" height="16" x="2" y="4" rx="2" />
                                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                            </svg>
                            Messages</button></li>
                    <li><button onclick="switchView('about')" class="admin-nav-btn" id="nav-about">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                            Profile</button></li>
                    <li><button onclick="switchView('settings')" class="admin-nav-btn" id="nav-settings">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            Settings</button></li>
                </ul>
            </div>
        </aside>

        <section class="admin-content">
            <!-- DASHBOARD OVERVIEW -->
            <div id="view-dashboard" class="admin-view active">
                <div class="view-header">
                    <h2>Overview</h2>
                </div>
                <div class="stats-grid">
                    <div class="glass-card stat-card">
                        <div class="stat-icon stories"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg></div>
                        <div>
                            <div class="stat-value" id="stat-posts">0</div>
                            <div class="stat-label">Total Stories</div>
                        </div>
                    </div>
                    <div class="glass-card stat-card">
                        <div class="stat-icon projects"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h11l5 5v11zM14 2v6h6" />
                            </svg></div>
                        <div>
                            <div class="stat-value" id="stat-projects">0</div>
                            <div class="stat-label">Active Projects</div>
                        </div>
                    </div>
                    <div class="glass-card stat-card">
                        <div class="stat-icon messages"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <rect width="20" height="16" x="2" y="4" rx="2" />
                                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                            </svg></div>
                        <div>
                            <div class="stat-value" id="stat-messages">0</div>
                            <div class="stat-label">New Messages</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INBOX VIEW -->
            <div id="view-messages" class="admin-view">
                <div class="view-header">
                    <h2>Inbox</h2>
                    <button onclick="loadMessages()" class="btn btn-outline" style="padding: 6px 12px;"
                        title="Refresh"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 2v6h-6"></path>
                            <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                            <path d="M3 22v-6h6"></path>
                            <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                        </svg></button>
                </div>
                <div class="inbox-container">
                    <!-- Sidebar -->
                    <div class="inbox-sidebar">
                        <div class="inbox-folder active" onclick="filterInbox('pending')" id="folder-pending">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z">
                                    </path>
                                    <polyline points="22,6 12,13 2,6"></polyline>
                                </svg>
                                <span>Pending</span>
                            </div>
                            <span class="badge" id="badge-pending" style="display: none;">0</span>
                        </div>
                        <div class="inbox-folder" onclick="filterInbox('attended')" id="folder-attended">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span>Attended</span>
                            </div>
                        </div>
                        <div class="inbox-folder" onclick="filterInbox('deleted')" id="folder-deleted">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                                <span>Bin</span>
                            </div>
                        </div>
                    </div>

                    <!-- Message List -->
                    <div class="message-list" id="inbox-list">
                        <!-- Items injected by JS -->
                        <div style="text-align: center; color: var(--text-muted); padding-top: 40px;">Loading...</div>
                    </div>

                    <!-- Message Detail -->
                    <div class="message-detail" id="message-detail">
                        <div style="text-align: center; color: var(--text-muted); padding-top: 100px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round"
                                stroke-linejoin="round" style="opacity: 0.3; margin-bottom: 16px;">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <p>Select a message to read</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POSTS VIEW -->
            <div id="view-posts" class="admin-view">
                <div class="view-header">
                    <h2>Manage Stories</h2>
                    <button onclick="toggleForm('admin-post-form-container')" class="btn btn-primary">New
                        Story</button>
                </div>

                <div id="admin-post-form-container" class="glass-card admin-form-container">
                    <h3 id="form-title" style="margin-bottom: 24px;">New Story</h3>
                    <form id="admin-post-form">
                        <input type="hidden" id="post-id">
                        <div class="form-group">
                            <label for="title">Post Title</label>
                            <input type="text" id="title" placeholder="A new era begins" required>
                        </div>
                        <div class="form-group">
                            <label for="content">Content (Markdown)</label>
                            <textarea id="content" placeholder="Share your thoughts..." rows="6" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="coverImage">Cover Image</label>
                            <div class="image-upload-container">
                                <div class="image-preview" id="post-image-preview"
                                    style="width: 100%; height: 200px; background: rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; display: none; background-size: cover; background-position: center;">
                                </div>
                                <input type="file" id="post-file-input" accept="image/*" class="form-control"
                                    onchange="handleImageUpload(this, 'coverImage', 'post-image-preview')">
                                <input type="hidden" id="coverImage">
                                <small style="color: var(--text-muted); display: block; margin-top: 4px;">Select an
                                    image to
                                    upload. Recommended: 1200x630px.</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tags">Categorize (Comma separated)</label>
                            <input type="text" id="tags" placeholder="tech, design, growth">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" class="btn btn-primary">Save Story</button>
                            <button type="button" onclick="toggleForm('admin-post-form-container')" id="cancel-edit"
                                style="display: none;" class="btn btn-outline">Cancel</button>
                        </div>
                    </form>
                </div>

                <div id="admin-post-list">
                    <p style="color: var(--text-muted);">Syncing stories...</p>
                </div>
            </div>

            <!-- PROJECTS VIEW -->
            <div id="view-projects" class="admin-view">
                <div class="view-header">
                    <h2>Portfolio Projects</h2>
                    <button onclick="toggleForm('admin-project-form-container')" class="btn btn-primary"
                        style="background: var(--secondary);">New Project</button>
                </div>

                <div id="admin-project-form-container" class="glass-card admin-form-container">
                    <h3 id="project-form-title" style="margin-bottom: 24px;">New Project</h3>
                    <form id="admin-project-form">
                        <input type="hidden" id="project-id">
                        <div class="form-group">
                            <label for="p-title">Project Name</label>
                            <input type="text" id="p-title" required placeholder="Nova Dashboard">
                        </div>
                        <div class="form-group">
                            <label for="p-description">Brief Description</label>
                            <textarea id="p-description" required rows="2"
                                placeholder="Minimal analytics project..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="p-content">Full Case Study (Details)</label>
                            <textarea id="p-content" rows="6"
                                placeholder="Explain the problem, solution, and challenges..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="p-link">Live Demo Link</label>
                            <input type="text" id="p-link" placeholder="https://my-app.com">
                        </div>
                        <div class="form-group">
                            <label for="p-github">GitHub Repo Link</label>
                            <input type="text" id="p-github" placeholder="https://github.com/user/repo">
                        </div>
                        <div class="form-group">
                            <label for="p-image">Project Preview Image</label>
                            <div class="image-upload-container">
                                <div class="image-preview" id="project-image-preview"
                                    style="width: 100%; height: 200px; background: rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; display: none; background-size: cover; background-position: center;">
                                </div>
                                <input type="file" id="project-file-input" accept="image/*" class="form-control"
                                    onchange="handleImageUpload(this, 'p-image', 'project-image-preview')">
                                <input type="hidden" id="p-image">
                                <small style="color: var(--text-muted); display: block; margin-top: 4px;">Select an
                                    image to
                                    upload.</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="p-technologies">Tech Stack</label>
                            <input type="text" id="p-technologies" placeholder="Node, React, Framer">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" class="btn btn-primary" style="background: var(--secondary);">Save
                                Project</button>
                            <button type="button" onclick="toggleForm('admin-project-form-container')"
                                id="cancel-p-edit" style="display: none;" class="btn btn-outline">Cancel</button>
                        </div>
                    </form>
                </div>

                <div id="admin-project-list">
                    <p style="color: var(--text-muted);">Syncing portfolio...</p>
                </div>
            </div>

            <!-- ABOUT VIEW -->
            <div id="view-about" class="admin-view">
                <div class="view-header">
                    <h2>Edit Profile</h2>
                </div>
                <div class="glass-card">
                    <form id="about-form">
                        <div class="form-group">
                            <label for="about-bio">Bio</label>
                            <textarea id="about-bio" placeholder="Your bio text..." rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="about-journey">Journey</label>
                            <textarea id="about-journey" placeholder="Your journey story..." rows="4"
                                required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="about-skills">Skills (one per line)</label>
                            <textarea id="about-skills"
                                placeholder="‚ú® Full-stack Web Development&#10;üé® UI/UX Design Systems&#10;üöÄ Performance Optimization"
                                rows="5" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="about-image">Profile Image</label>
                            <div class="image-upload-container">
                                <div class="image-preview" id="about-image-preview"
                                    style="width: 150px; height: 150px; background: rgba(0,0,0,0.1); border-radius: 50%; margin: 0 auto 12px; display: none; background-size: cover; background-position: center;">
                                </div>
                                <input type="file" id="about-file-input" accept="image/*" class="form-control"
                                    onchange="handleImageUpload(this, 'about-image', 'about-image-preview')">
                                <input type="hidden" id="about-image" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <div id="about-status" style="margin-top: 12px; font-size: 0.85rem; display: none;"></div>
                    </form>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="admin-view">
                <div class="view-header">
                    <h2>Security Settings</h2>
                </div>
                <div class="glass-card" style="max-width: 500px;">
                    <h3>Update Password</h3>
                    <form id="password-form" style="margin-top: 24px;">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" id="current-pw" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="new-pw" required>
                        </div>
                        <button type="submit" class="btn btn-outline" style="width: 100%;">Update Password</button>
                        <div id="pw-status"
                            style="margin-top: 12px; font-size: 0.85rem; text-align: center; display: none;"></div>
                    </form>
                </div>
            </div>
        </section>
    </main>


    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        // --- Authentication Check ---
        if (!api.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // --- Navigation Logic ---
        function switchView(viewId) {
            // Hide all views
            document.querySelectorAll('.admin-view').forEach(view => {
                view.classList.remove('active');
            });
            // Show selected view
            const selectedView = document.getElementById(`view-${viewId}`);
            if (selectedView) selectedView.classList.add('active');

            // Update Nav Buttons
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`nav-${viewId}`);
            if (activeBtn) activeBtn.classList.add('active');

            // Trigger data load if needed
            if (viewId === 'dashboard') loadDashboardStats();
            if (viewId === 'messages') loadMessages();
        }

        function toggleForm(formId) {
            const form = document.getElementById(formId);
            if (form) form.classList.toggle('open');
        }

        // --- Dashboard Logic ---
        async function loadDashboardStats() {
            try {
                const [posts, projects, messages] = await Promise.all([
                    api.getPosts(),
                    api.getProjects(),
                    api.getMessages()
                ]);
                animateValue("stat-posts", 0, posts.length, 1000);
                animateValue("stat-projects", 0, projects.length, 1000);
                animateValue("stat-messages", 0, messages.length, 1000);
            } catch (error) { console.error("Error loading stats:", error); }
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- Inbox Logic ---
        let currentInboxStatus = 'pending';
        let inboxMessages = [];

        async function loadMessages() {
            // Also refresh badges
            updateInboxBadges();
            filterInbox(currentInboxStatus);
        }

        function closeMessageDetail() {
            document.getElementById('message-detail').classList.remove('active');
        }

        async function updateInboxBadges() {
            try {
                // Fetch all messages (optimization: backend could provide a counts endpoint, but list is small enough)
                const all = await api.getMessages(); // Gets non-deleted
                const pendingCount = all.filter(m => m.status === 'pending').length;

                const badge = document.getElementById('badge-pending');
                badge.innerText = pendingCount;
                badge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
            } catch (e) { }
        }

        async function filterInbox(status) {
            currentInboxStatus = status;

            // Update Sidebar UI
            document.querySelectorAll('.inbox-folder').forEach(f => f.classList.remove('active'));
            document.getElementById(`folder-${status}`).classList.add('active');

            // Reset Detail View
            document.getElementById('message-detail').innerHTML = `
                <div style="text-align: center; color: var(--text-muted); padding-top: 100px;">
                    <p>Select a message to read</p>
                </div>
            `;

            const list = document.getElementById('inbox-list');
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';

            try {
                inboxMessages = await api.getMessages(status);
                renderInboxList(inboxMessages);
            } catch (error) {
                list.innerHTML = '<p style="color:#ef4444; text-align:center;">Failed to load.</p>';
            }
        }

        function renderInboxList(messages) {
            const list = document.getElementById('inbox-list');
            list.innerHTML = '';

            if (messages.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Folder is empty</div>';
                return;
            }

            messages.forEach(msg => {
                const date = new Date(msg.createdAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const div = document.createElement('div');
                div.className = 'message-preview';
                div.onclick = () => viewMessage(msg._id);
                div.innerHTML = `
                    <div class="msg-header">
                        <span class="msg-sender">${msg.name}</span>
                        <span>${date}</span>
                    </div>
                    <div style="font-size: 0.85rem; font-weight: 500; margin-bottom: 4px;">${msg.email}</div>
                    <div class="msg-snippet">${msg.message}</div>
                `;
                list.appendChild(div);
            });
        }

        function viewMessage(id) {
            const msg = inboxMessages.find(m => m._id === id);
            if (!msg) return;

            // Update active state in list
            // (Optional: add .active to clicked item, requires tracking DOM elements)

            const detail = document.getElementById('message-detail');
            const date = new Date(msg.createdAt).toLocaleString();

            let actions = '';
            if (currentInboxStatus === 'pending') {
                actions = `
                    <button onclick="updateMessageStatus('${msg._id}', 'attended')" class="btn btn-primary" style="font-size: 0.9rem;">Mark Attended</button>
                    <button onclick="deleteMessage('${msg._id}')" class="btn btn-outline" style="font-size: 0.9rem; color: #ef4444; border-color: #ef4444;">Move to Bin</button>
                `;
            } else if (currentInboxStatus === 'attended') {
                actions = `
                    <button onclick="updateMessageStatus('${msg._id}', 'pending')" class="btn btn-outline" style="font-size: 0.9rem;">Mark Pending</button>
                    <button onclick="deleteMessage('${msg._id}')" class="btn btn-outline" style="font-size: 0.9rem; color: #ef4444; border-color: #ef4444;">Move to Bin</button>
                `;
            } else if (currentInboxStatus === 'deleted') {
                actions = `
                    <button onclick="updateMessageStatus('${msg._id}', 'pending')" class="btn btn-outline" style="font-size: 0.9rem;">Restore</button>
                    <button onclick="hardDeleteMessage('${msg._id}')" class="btn btn-primary" style="font-size: 0.9rem; background: #ef4444; border-color: #ef4444;">Delete Permanently</button>
                `;
            }

            detail.innerHTML = `
                <div class="detail-header">
                    <button onclick="closeMessageDetail()" class="btn btn-outline mobile-only" style="margin-bottom: 16px; padding: 4px 12px; font-size: 0.8rem;">
                        ‚Üê Back
                    </button>
                    <div class="detail-meta">
                        <span class="msg-status-badge status-${msg.status}">${msg.status}</span>
                        <span style="color: var(--text-muted); font-size: 0.9rem;">${date}</span>
                    </div>
                    <div class="detail-sender">${msg.name}</div>
                    <div class="detail-email">${msg.email}</div>
                </div>
                <div style="line-height: 1.6; white-space: pre-wrap; font-size: 1rem;">${msg.message}</div>
                <div class="detail-actions">
                    ${actions}
                </div>
            `;

            // On mobile, show the detail view
            if (window.innerWidth <= 1024) {
                detail.classList.add('active');
            } else {
                detail.style.display = 'block'; // Ensure it's visible on desktop
            }
        }

        async function updateMessageStatus(id, status) {
            try {
                await api.updateMessageStatus(id, status);
                loadMessages(); // Refresh UI
            } catch (error) { alert('Action failed'); }
        }

        async function deleteMessage(id) {
            if (confirm('Move this message to the Bin?')) {
                try {
                    await api.deleteMessage(id);
                    loadMessages();
                } catch (error) { alert('Action failed'); }
            }
        }

        async function hardDeleteMessage(id) {
            if (confirm('Permanently delete this message? This cannot be undone.')) {
                try {
                    await api.hardDeleteMessage(id);
                    loadMessages();
                } catch (error) { alert('Action failed'); }
            }
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            api.logout();
            window.location.href = 'login.html';
        });

        // --- Image Upload Logic ---
        async function handleImageUpload(input, hiddenInputId, previewId) {
            const file = input.files[0];
            if (!file) return;

            const hiddenInput = document.getElementById(hiddenInputId);
            const preview = document.getElementById(previewId);

            // Show loading state (optional: turn preview opacity down or show spinner)
            preview.style.opacity = '0.5';

            try {
                const res = await api.uploadImage(file);
                // Success
                hiddenInput.value = res.location;
                preview.style.backgroundImage = `url('${api.getStaticUrl(res.location)}')`;
                preview.style.display = 'block';
            } catch (error) {
                console.error("Upload failed", error);
                alert("Failed to upload image.");
            } finally {
                preview.style.opacity = '1';
                input.value = ''; // Reset file input so same file can be selected again if needed
            }
        }

        // --- Content Management ---
        const postForm = document.getElementById('admin-post-form');
        const postList = document.getElementById('admin-post-list');
        const pForm = document.getElementById('admin-project-form');
        const pList = document.getElementById('admin-project-list');
        const pwForm = document.getElementById('password-form');

        async function loadContent() {
            try {
                // Show loading states
                postList.innerHTML = '<p class="text-muted" style="text-align: center;">Syncing stories...</p>';
                pList.innerHTML = '<p class="text-muted" style="text-align: center;">Syncing portfolio...</p>';

                // Load Posts
                // Use explicit no-cache or timestamp to force fresh fetch if needed, 
                // though api.getPosts() uses fetch which usually hits network. 
                // We'll trust the API but ensure UI updates.
                const posts = await api.getPosts();
                postList.innerHTML = '';

                if (posts.length === 0) {
                    postList.innerHTML = '<p class="text-muted" style="text-align: center;">No stories yet. Create one!</p>';
                } else {
                    // Sort by newest first just in case backend doesn't
                    // (Backend controller usually sorts, but good to be safe)
                    posts.forEach(post => {
                        const div = document.createElement('div');
                        div.className = 'glass-card item-row active';
                        // Add fade-in animation
                        div.style.animation = 'fadeIn 0.3s ease';
                        div.innerHTML = `
                        <div>
                            <strong>${post.title}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                ${formatDate(post.createdAt)} 
                                ${post.status ? `‚Ä¢ <span style="text-transform:capitalize">${post.status}</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editPost('${post._id}')" class="btn btn-outline" style="padding: 6px 14px; font-size: 0.8rem;">Edit</button>
                            <button onclick="deletePost('${post._id}')" class="btn" style="padding: 6px 14px; font-size: 0.8rem; background: rgba(239, 68, 68, 0.1); color: #ef4444;">Delete</button>
                        </div>
                    `;
                        postList.appendChild(div);
                    });
                }

                // Load Projects
                const projects = await api.getProjects();
                pList.innerHTML = '';
                if (projects.length === 0) {
                    pList.innerHTML = '<p class="text-muted" style="text-align: center;">No projects yet.</p>';
                } else {
                    projects.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'glass-card item-row active';
                        div.style.animation = 'fadeIn 0.3s ease';
                        div.innerHTML = `
                        <div>
                            <strong>${p.title}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${p.description.substring(0, 40)}...</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editProject('${p._id}')" class="btn btn-outline" style="padding: 6px 14px; font-size: 0.8rem;">Edit</button>
                            <button onclick="deleteProject('${p._id}')" class="btn" style="padding: 6px 14px; font-size: 0.8rem; background: rgba(239, 68, 68, 0.1); color: #ef4444;">Delete</button>
                        </div>
                    `;
                        pList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error("Load Content Error:", error);
                if (postList) postList.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load stories.</p>';
                if (pList) pList.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load projects.</p>';

                if (error.message && (error.message.includes('authorized') || error.status === 401)) {
                    api.logout();
                    window.location.href = 'login.html';
                }
            }
        }

        // Load About Content
        async function loadAboutContent() {
            try {
                const response = await fetch('/api/about');
                const data = await response.json();

                document.getElementById('about-bio').value = data.bio || '';
                document.getElementById('about-journey').value = data.journey || '';
                document.getElementById('about-skills').value = data.skills ? data.skills.join('\n') : '';
                document.getElementById('about-image').value = data.profileImage || '';

                if (data.profileImage) {
                    const preview = document.getElementById('about-image-preview');
                    preview.style.display = 'block';
                    preview.style.backgroundImage = `url('${api.getStaticUrl(data.profileImage)}')`;
                }
            } catch (error) {
                console.error('Error loading about content:', error);
            }
        }

        // About Form Handler
        const aboutForm = document.getElementById('about-form');
        const aboutStatus = document.getElementById('about-status');

        aboutForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const bio = document.getElementById('about-bio').value.trim();
            const journey = document.getElementById('about-journey').value.trim();
            const skillsText = document.getElementById('about-skills').value.trim();
            const profileImage = document.getElementById('about-image').value.trim();

            // Convert skills textarea to array (split by newlines)
            const skills = skillsText.split('\n').filter(s => s.trim() !== '');

            try {
                // Use the new API method
                const data = await api.updateAbout({ bio, journey, skills, profileImage });

                aboutStatus.textContent = '‚úì About content updated successfully!';
                aboutStatus.style.color = 'var(--primary)';
                aboutStatus.style.display = 'block';
                setTimeout(() => { aboutStatus.style.display = 'none'; }, 3000);
            } catch (error) {
                console.error(error);
                aboutStatus.textContent = `‚úó ${error.message}`;
                aboutStatus.style.color = '#ef4444';
                aboutStatus.style.display = 'block';

                if (error.message.includes('authorized') || error.status === 401) {
                    api.logout();
                    window.location.href = 'login.html';
                }
            }
        });

        // Post Management
        // Initialize TinyMCE
        tinymce.init({
            selector: '#content, #p-content',
            plugins: 'image link lists table code help wordcount',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help | image code table',
            height: 500,
            images_upload_handler: async function (blobInfo, success, failure) {
                const formData = new FormData();
                formData.append('image', blobInfo.blob(), blobInfo.filename());

                try {
                    const token = localStorage.getItem('adminToken');
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Image upload failed');
                    }

                    const json = await response.json();
                    return json.location;
                } catch (error) {
                    console.error('Image upload error:', error);
                    throw new Error('Image upload failed');
                }
            },
            setup: function (editor) {
                editor.on('change', function () {
                    editor.save();
                });
            }
        });



        // ... (other refs)

        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('post-id').value;

            // Get content from TinyMCE
            const content = tinymce.get('content').getContent();

            const data = {
                title: document.getElementById('title').value,
                content: content,
                coverImage: document.getElementById('coverImage').value,
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t !== '')
            };
            try {
                if (id) {
                    await api.updatePost(id, data);
                } else {
                    await api.createPost(data);
                }

                // Reset form
                postForm.reset();
                tinymce.get('content').setContent(''); // Clear editor
                document.getElementById('post-id').value = '';
                document.getElementById('cancel-edit').style.display = 'none';
                document.getElementById('form-title').textContent = 'Add Post';

                // Refresh list
                await loadContent();
                alert('Story saved successfully!');
            } catch (error) {
                console.error("Post save error:", error);
                alert('Error saving story: ' + (error.message || 'Unknown error'));
            }
        });

        async function editPost(id) {
            try {
                const post = await api.getPost(id);
                document.getElementById('post-id').value = post._id;
                document.getElementById('title').value = post.title;
                tinymce.get('content').setContent(post.content);
                document.getElementById('coverImage').value = post.coverImage || '';

                // Update Preview
                const preview = document.getElementById('post-image-preview');
                if (post.coverImage) {
                    preview.style.display = 'block';
                    preview.style.backgroundImage = `url('${post.coverImage}')`;
                } else {
                    preview.style.display = 'none';
                }

                document.getElementById('tags').value = (post.tags || []).join(', ');
                document.getElementById('form-title').textContent = 'Modify Story';
                document.getElementById('cancel-edit').style.display = 'block';
                // Scroll to top of form container
                document.getElementById('admin-post-form-container').scrollIntoView({ behavior: 'smooth' });
                toggleForm('admin-post-form-container'); // Ensure open
                if (!document.getElementById('admin-post-form-container').classList.contains('open')) {
                    document.getElementById('admin-post-form-container').classList.add('open');
                }
            } catch (error) { console.error(error); }
        }

        async function deletePost(id) {
            if (confirm('Permanently remove this story?')) {
                await api.deletePost(id);
                loadContent();
            }
        }

        // Project Management
        pForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('project-id').value;
            const data = {
                title: document.getElementById('p-title').value,
                description: document.getElementById('p-description').value,
                content: tinymce.get('p-content').getContent(),
                link: document.getElementById('p-link').value,
                githubLink: document.getElementById('p-github').value,
                image: document.getElementById('p-image').value,
                technologies: document.getElementById('p-technologies').value.split(',').map(t => t.trim()).filter(t => t !== '')
            };
            try {
                if (id) await api.updateProject(id, data);
                else await api.createProject(data);
                pForm.reset();
                tinymce.get('p-content').setContent(''); // Clear editor
                document.getElementById('project-id').value = '';
                document.getElementById('cancel-p-edit').style.display = 'none';
                document.getElementById('project-form-title').textContent = 'New Project';
                loadContent();
            } catch (error) { alert('Unauthorized or server error.'); }
        });

        async function editProject(id) {
            try {
                const p = await api.getProject(id);
                document.getElementById('project-id').value = p._id;
                document.getElementById('p-title').value = p.title;
                document.getElementById('p-description').value = p.description;
                // document.getElementById('p-content').value = p.content || '';
                tinymce.get('p-content').setContent(p.content || '');
                document.getElementById('p-link').value = p.link || '';
                document.getElementById('p-github').value = p.githubLink || '';
                document.getElementById('p-image').value = p.image || '';

                // Update Preview
                const preview = document.getElementById('project-image-preview');
                if (p.image) {
                    preview.style.display = 'block';
                    preview.style.backgroundImage = `url('${p.image}')`;
                } else {
                    preview.style.display = 'none';
                }

                document.getElementById('p-technologies').value = p.technologies ? p.technologies.join(', ') : '';

                document.getElementById('project-form-title').innerText = 'Edit Project';
                document.getElementById('cancel-p-edit').style.display = 'inline-block';

                // Scroll and open
                document.getElementById('admin-project-form-container').scrollIntoView({ behavior: 'smooth' });
                if (!document.getElementById('admin-project-form-container').classList.contains('open')) {
                    document.getElementById('admin-project-form-container').classList.add('open');
                }
            } catch (error) { console.error(error); }
        }


        async function deleteProject(id) {
            if (confirm('Permanently remove this project?')) {
                await api.deleteProject(id);
                loadContent();
            }
        }

        // Password Update
        pwForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const status = document.getElementById('pw-status');
            const data = {
                currentPassword: document.getElementById('current-pw').value,
                newPassword: document.getElementById('new-pw').value
            };
            try {
                const res = await api.updatePassword(data);
                status.textContent = res.message;
                status.style.display = 'block';
                status.style.color = res.message.includes('success') ? '#10b981' : '#ef4444';
                if (res.message.includes('success')) pwForm.reset();
            } catch (error) {
                status.textContent = 'Failed to update.';
                status.style.display = 'block';
                status.style.color = '#ef4444';
            }
        });

        document.getElementById('cancel-edit').onclick = () => {
            postForm.reset();
            document.getElementById('post-id').value = '';
            document.getElementById('cancel-edit').style.display = 'none';
            document.getElementById('form-title').textContent = 'Add Post';
        };

        document.getElementById('cancel-p-edit').onclick = () => {
            pForm.reset();
            document.getElementById('project-id').value = '';
            document.getElementById('cancel-p-edit').style.display = 'none';
            document.getElementById('project-form-title').textContent = 'New Project';
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardStats(); // Load stats for dashboard view
            loadContent();
            loadAboutContent();
        });
    </script>
</body>

</html>